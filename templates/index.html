<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" type="text/css" href="/static/style.css">
    <link rel="stylesheet" type="text/css" href="/static/normalize.css">
    <title>Pick a Pic</title>
</head>
<body>

<div class="splash-screen" id="splash-screen">
    <div class="splash-screen-inner" id="intro">
        <h1>Pick a Pic</h1>
        <p> Human feedback led to dramatic improvements in natural language processing.
            In this project we wish to initiate a community effort to use human feedback in text-to-image
            generation.
            Being a community effort, all the code, data, and models resulting from this project will be completely
            open-sourced.
            We welcome any contributions and help with this effort.</p>
        <div class="splash-screen-buttons">
            <button class="splash-screen-button" id="next-button-intro">Next</button>
        </div>
    </div>
    <div class="splash-screen-inner" id="legal-notice" style="display: none;">
        <h1>Legal Notice</h1>
        <p>By using this demo, you agree to the following terms and conditions:</p>
        <ul>
            <li>This demo is intended for research purposes only.</li>
            <li>The authors are not responsible for any misuse of the demo. This includes damages or losses that may
                result from using the demo.
            </li>
            <li>By using the demo, the users grant consent for their prompts, interactions, and generated images to
                be collected and eventually released into the public domain.
            </li>
        </ul>
        <div class="splash-screen-buttons">
            <button class="splash-screen-button" id="back-button" style="margin-right: 0.5vh">Back</button>
            <button class="splash-screen-button" id="next-button-legal">Next</button>
        </div>
    </div>
    <div class="splash-screen-inner" id="google-sign-in" style="display: none;">
        <h1>Pick a Pic</h1>
        <p> The last step before participating and using the demo is to authenticate that you are a real human
            user.
        </p>
        <div class="splash-screen-buttons">
            <button class="splash-screen-button" id="google-back-button" style="margin-right: 0.5vh">Back</button>
            <button class="splash-screen-button" id="google-button">Sign in with Google</button>
        </div>
    </div>
    <div class="splash-screen-inner" id="model-info" style="display: none;">
        <h1>Pick a Pic</h1>
        <p> Currently we use <a href="https://huggingface.co/stabilityai/stable-diffusion-2-1"
                                style="font-weight: bold; text-decoration: none; color: lightgrey">Stable diffusion 2.1</a>
            with a guidance scale of 9. If you think that there is a better open-sourced model available, or would like
            to suggest
            better approaches to employ this model, please contact us.</p>
        <div class="splash-screen-buttons">
            <button class="splash-screen-button" id="model-info-button" style="margin-right: 0.5vh">Return to demo
            </button>
        </div>
    </div>
</div>

<div class="parent" style="top: 0;">

    <div class="top-buttons">
        <a href="/logout">
            <button class="top-button" id="logout-button">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                     class="bi bi-box-arrow-right" viewBox="0 0 16 16">
                    <path fill-rule="evenodd"
                          d="M10 12.5a.5.5 0 0 1-.5.5h-8a.5.5 0 0 1-.5-.5v-9a.5.5 0 0 1 .5-.5h8a.5.5 0 0 1 .5.5v2a.5.5 0 0 0 1 0v-2A1.5 1.5 0 0 0 9.5 2h-8A1.5 1.5 0 0 0 0 3.5v9A1.5 1.5 0 0 0 1.5 14h8a1.5 1.5 0 0 0 1.5-1.5v-2a.5.5 0 0 0-1 0v2z"/>
                    <path fill-rule="evenodd"
                          d="M15.854 8.354a.5.5 0 0 0 0-.708l-3-3a.5.5 0 0 0-.708.708L14.293 7.5H5.5a.5.5 0 0 0 0 1h8.793l-2.147 2.146a.5.5 0 0 0 .708.708l3-3z"/>
                </svg>
            </button>
        </a>
        <a href=https://discord.gg/qKEVkF85DT" target="_blank">
            <button class="top-button">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-discord"
                     viewBox="0 0 16 16">
                    <path d="M13.545 2.907a13.227 13.227 0 0 0-3.257-1.011.05.05 0 0 0-.052.025c-.141.25-.297.577-.406.833a12.19 12.19 0 0 0-3.658 0 8.258 8.258 0 0 0-.412-.833.051.051 0 0 0-.052-.025c-1.125.194-2.22.534-3.257 1.011a.041.041 0 0 0-.021.018C.356 6.024-.213 9.047.066 12.032c.001.014.01.028.021.037a13.276 13.276 0 0 0 3.995 2.02.05.05 0 0 0 .056-.019c.308-.42.582-.863.818-1.329a.05.05 0 0 0-.01-.059.051.051 0 0 0-.018-.011 8.875 8.875 0 0 1-1.248-.595.05.05 0 0 1-.02-.066.051.051 0 0 1 .015-.019c.084-.063.168-.129.248-.195a.05.05 0 0 1 .051-.007c2.619 1.196 5.454 1.196 8.041 0a.052.052 0 0 1 .053.007c.08.066.164.132.248.195a.051.051 0 0 1-.004.085 8.254 8.254 0 0 1-1.249.594.05.05 0 0 0-.03.03.052.052 0 0 0 .003.041c.24.465.515.909.817 1.329a.05.05 0 0 0 .056.019 13.235 13.235 0 0 0 4.001-2.02.049.049 0 0 0 .021-.037c.334-3.451-.559-6.449-2.366-9.106a.034.034 0 0 0-.02-.019Zm-8.198 7.307c-.789 0-1.438-.724-1.438-1.612 0-.889.637-1.613 1.438-1.613.807 0 1.45.73 1.438 1.613 0 .888-.637 1.612-1.438 1.612Zm5.316 0c-.788 0-1.438-.724-1.438-1.612 0-.889.637-1.613 1.438-1.613.807 0 1.451.73 1.438 1.613 0 .888-.631 1.612-1.438 1.612Z"/>
                </svg>
            </button>
        </a>
        <a href="mailto:pickapic.io@gmail.com">
            <button class="top-button">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                     class="bi bi-envelope-at-fill" viewBox="0 0 16 16">
                    <path d="M2 2A2 2 0 0 0 .05 3.555L8 8.414l7.95-4.859A2 2 0 0 0 14 2H2Zm-2 9.8V4.698l5.803 3.546L0 11.801Zm6.761-2.97-6.57 4.026A2 2 0 0 0 2 14h6.256A4.493 4.493 0 0 1 8 12.5a4.49 4.49 0 0 1 1.606-3.446l-.367-.225L8 9.586l-1.239-.757ZM16 9.671V4.697l-5.803 3.546.338.208A4.482 4.482 0 0 1 12.5 8c1.414 0 2.675.652 3.5 1.671Z"/>
                    <path d="M15.834 12.244c0 1.168-.577 2.025-1.587 2.025-.503 0-1.002-.228-1.12-.648h-.043c-.118.416-.543.643-1.015.643-.77 0-1.259-.542-1.259-1.434v-.529c0-.844.481-1.4 1.26-1.4.585 0 .87.333.953.63h.03v-.568h.905v2.19c0 .272.18.42.411.42.315 0 .639-.415.639-1.39v-.118c0-1.277-.95-2.326-2.484-2.326h-.04c-1.582 0-2.64 1.067-2.64 2.724v.157c0 1.867 1.237 2.654 2.57 2.654h.045c.507 0 .935-.07 1.18-.18v.731c-.219.1-.643.175-1.237.175h-.044C10.438 16 9 14.82 9 12.646v-.214C9 10.36 10.421 9 12.485 9h.035c2.12 0 3.314 1.43 3.314 3.034v.21Zm-4.04.21v.227c0 .586.227.8.581.8.31 0 .564-.17.564-.743v-.367c0-.516-.275-.708-.572-.708-.346 0-.573.245-.573.791Z"/>
                </svg>
            </button>
        </a>
        <button class="top-button" onclick="activateLegalNotice()">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                 class="bi bi-bookmark-check" viewBox="0 0 16 16">
                <path fill-rule="evenodd"
                      d="M10.854 5.146a.5.5 0 0 1 0 .708l-3 3a.5.5 0 0 1-.708 0l-1.5-1.5a.5.5 0 1 1 .708-.708L7.5 7.793l2.646-2.647a.5.5 0 0 1 .708 0z"/>
                <path d="M2 2a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v13.5a.5.5 0 0 1-.777.416L8 13.101l-5.223 2.815A.5.5 0 0 1 2 15.5V2zm2-1a1 1 0 0 0-1 1v12.566l4.723-2.482a.5.5 0 0 1 .554 0L13 14.566V2a1 1 0 0 0-1-1H4z"/>
            </svg>
        </button>
        <button class="top-button" onclick="activateModelInfo()">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-robot"
                 viewBox="0 0 16 16">
                <path d="M6 12.5a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 0 1h-3a.5.5 0 0 1-.5-.5ZM3 8.062C3 6.76 4.235 5.765 5.53 5.886a26.58 26.58 0 0 0 4.94 0C11.765 5.765 13 6.76 13 8.062v1.157a.933.933 0 0 1-.765.935c-.845.147-2.34.346-4.235.346-1.895 0-3.39-.2-4.235-.346A.933.933 0 0 1 3 9.219V8.062Zm4.542-.827a.25.25 0 0 0-.217.068l-.92.9a24.767 24.767 0 0 1-1.871-.183.25.25 0 0 0-.068.495c.55.076 1.232.149 2.02.193a.25.25 0 0 0 .189-.071l.754-.736.847 1.71a.25.25 0 0 0 .404.062l.932-.97a25.286 25.286 0 0 0 1.922-.188.25.25 0 0 0-.068-.495c-.538.074-1.207.145-1.98.189a.25.25 0 0 0-.166.076l-.754.785-.842-1.7a.25.25 0 0 0-.182-.135Z"/>
                <path d="M8.5 1.866a1 1 0 1 0-1 0V3h-2A4.5 4.5 0 0 0 1 7.5V8a1 1 0 0 0-1 1v2a1 1 0 0 0 1 1v1a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2v-1a1 1 0 0 0 1-1V9a1 1 0 0 0-1-1v-.5A4.5 4.5 0 0 0 10.5 3h-2V1.866ZM14 7.5V13a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V7.5A3.5 3.5 0 0 1 5.5 4h5A3.5 3.5 0 0 1 14 7.5Z"/>
            </svg>
        </button>
    </div>
    <div class="container" style="top: 0; margin-top: 0">
        <div class="title-button-container">
            <h1 style="font-size: large;text-align: center;">Pick a Pic</h1>
            <div class="button-container">
                <button id="submit-button" style="margin-right: 0">Generate</button>
                <button id="download-button" style="display: none">Download</button>
            </div>
        </div>
        <input type="text" id="prompt" placeholder="An image of...">
    </div>


    <div class="progress-container" style="display: block">
        <div class="status-text" style="width: 100%"></div>
        <div class="progress-bar-background" style="display: none">
            <div class="progress-bar"></div>
        </div>
    </div>
    <div class="container" style="display: block" id="image-grid-container">
        <div class="image-grid">
            <div class="image-container">
                <img class="img after_clicked" src="https://loremflickr.com/512/512" id="image-grid-item-0-image"
                     style="opacity: 0">
            </div>
            <div class="image-container">
                <img class="img after_clicked" src="https://loremflickr.com/512/512" id="image-grid-item-0-image"
                     style="opacity: 0">
            </div>
            <div class="image-container">
                <img class="img after_clicked" src="https://loremflickr.com/512/512" id="image-grid-item-0-image"
                     style="opacity: 0">
            </div>
            <div class="image-container">
                <img class="img after_clicked" src="https://loremflickr.com/512/512" id="image-grid-item-0-image"
                     style="opacity: 0">
            </div>
        </div>
    </div>
</div>

<div class="splash-screen" id="error-screen" style="display: none">
    <div class="splash-screen-inner" id="error">
        <h1>Pick a Pic</h1>
        <p> OMG. Given our current resources, there are too many users. Please to refresh in a minute or two.</p>
    </div>
</div>


<script>
    {#const clearButton = document.getElementById('clear-button');#}
    const submitButton = document.getElementById('submit-button');
    const downloadButton = document.getElementById('download-button');
    const promptInput = document.getElementById('prompt');
    const imageGridContainer = document.getElementById('image-grid-container');
    const imageGrid = document.querySelector('.image-grid');
    const statusText = document.querySelector('.status-text');
    let formerPromptInput = ""

    {% if is_authenticated %}
        const is_authenticated = true;
    {% else %}
        const is_authenticated = false;
    {% endif %}

    console.log(is_authenticated)
    {#const originalButtonWidth = clearButton.style.width;#}

    const splashScreen = document.getElementById('splash-screen');
    const nextButtonIntro = document.getElementById('next-button-intro');
    const nextButtonLegal = document.getElementById('next-button-legal');
    const backButton = document.getElementById('back-button');
    const intro = document.getElementById('intro');
    const legalNotice = document.getElementById('legal-notice');
    const googleSignIn = document.getElementById('google-sign-in');
    const googleBackButton = document.getElementById('google-back-button');
    const googleSignInButton = document.getElementById('google-button');
    const modelInfo = document.getElementById('model-info');
    const modelInfoButton = document.getElementById('model-info-button');

    if (is_authenticated) {
        splashScreen.style.display = 'none';
        intro.style.display = 'none';
        legalNotice.style.display = 'none';
        googleSignIn.style.display = 'none';
    }

    function activateLegalNotice() {
        splashScreen.style.display = 'block';
        legalNotice.style.display = 'block';
        nextButtonLegal.innerText = 'Return to demo';
        backButton.style.display = 'none';
    }

    function activateModelInfo() {
        splashScreen.style.display = 'block';
        modelInfo.style.display = 'block';
    }

    modelInfoButton.addEventListener('click', () => {
        modelInfo.style.display = 'none';
        splashScreen.style.display = 'none';
    });

    nextButtonIntro.addEventListener('click', () => {
        // Toggle the display of the legal notice
        console.log('Showing legal notice');
        intro.style.display = 'none';
        legalNotice.style.display = 'block';
        backButton.style.display = 'block';
    });

    nextButtonLegal.addEventListener('click', () => {
        // Toggle the display of the legal notice
        console.log('Finished splash screen');
        if (is_authenticated) {
            splashScreen.style.display = 'none';
        } else {
            googleSignIn.style.display = 'block';
        }
        legalNotice.style.display = 'none';
    });

    backButton.addEventListener('click', () => {
        // Toggle the display of the legal notice
        console.log('Showing intro');
        intro.style.display = 'block';
        legalNotice.style.display = 'none';
    });

    googleSignInButton.addEventListener('click', () => {
        const a = document.createElement('a');
        a.href = "/login";
        document.body.appendChild(a);
        a.click();
    });

    googleBackButton.addEventListener('click', () => {
        // Toggle the display of the legal notice
        console.log('Showing intro');
        legalNotice.style.display = 'block';
        googleSignIn.style.display = 'none';
    });

    {#function clearDemo() {#}
    {#    const clearButton = document.getElementById('clear-button');#}
    {#    const submitButton = document.getElementById('submit-button');#}
    {#    const downloadButton = document.getElementById('download-button');#}
    {#    const statusText = document.querySelector('.status-text');#}
    {##}
    {#    statusText.innerText = '';#}
    {#    promptInput.value = '';#}
    {#    downloadButton.style.display = 'none';#}
    {#    submitButton.style.display = 'inline-block';#}
    {#    submitButton.disabled = false;#}
    {#    submitButton.style.width = '49%';#}
    {#    clearButton.style.width = '49%';#}
    {#    const imageContainerChildren = imageGrid.children;#}
    {#    for (let i = 0; i < imageContainerChildren.length; i++) {#}
    {#        const imageChildren = imageContainerChildren[i].children;#}
    {#        for (let j = 0; j < imageChildren.length; j++) {#}
    {#            const image = imageChildren[j];#}
    {#            image.style.opacity = 0;#}
    {#            image.classList.add('after_clicked');#}
    {#        }#}
    {#    }#}
    {# }#}

    {#clearButton.addEventListener('click', function () {#}
    {#    clearDemo();#}
    {# });#}

    function onImageClick(event) {
        const image = event.target;
        const prompt = promptInput.value;
        const allImages = document.querySelectorAll('.image-grid img');
        const imageIds = [];

        for (let i = 0; i < allImages.length; i++) {
            imageIds.push(allImages[i].imageId);
        }
        console.log('Clicked image ' + image.idx);
        fetch('/update_clicked_image/', {
            method: 'POST',
            body: JSON.stringify({image_uid: image.imageId, image_uids: imageIds, prompt: prompt}),
            headers: {
                'Content-Type': 'application/json'
            }
        }).then(response => {
            // API call success
            console.log('Successfully updated clicked image');
        }).catch(error => {
            // API call error
            console.error('Error updating clicked image:', error);
        });

        downloadButton.style.display = 'inline-block';
        {#downloadButton.style.width = '49%';#}
        downloadButton.href = image.src;

        submitButton.style.display = 'block';
        {#submitButton.style.width = '49%';#}
        submitButton.style.marginRight = '2%';

        // Make other images darker
        const otherImages = document.querySelectorAll('.image-grid img:not(:hover)');
        for (let i = 0; i < otherImages.length; i++) {
            otherImages[i].style.filter = 'brightness(50%)';
            otherImages[i].classList.add('after_clicked');
        }
        image.classList.add('after_clicked');
        image.classList.add('clicked');

        statusText.innerText = ""
        window.scrollTo(0, 0)

        // Enable submit button to generate more images
        {#clearButton.style.width = '33%';#}
        {#clearButton.style.marginRight = '0.5%';#}
        {#submitButton.style.marginRight = '0.5%';#}
    }

    function updateImages(data) {
        const images = data.images;
        const imageIds = data.image_uids;
        let clickedImage = document.querySelector('.clicked');

        // Clear current images
        while (imageGrid.firstChild) {
            imageGrid.removeChild(imageGrid.firstChild);
        }

        // Add new images
        for (let i = 0; i < images.length; i++) {

            let imageData = images[i];
            let imageId = imageIds[i];
            const imageContainer = document.createElement('div');
            imageContainer.classList.add('image-container');
            const img = document.createElement('img');
            // Keep clicked image
            if (clickedImage && i === clickedImage.idx && promptInput.value === formerPromptInput) {
                imageId = clickedImage.imageId;
                imageData = clickedImage.imageData;
            }

            img.src = 'data:image/jpeg;base64,' + imageData;
            img.imageId = imageId;
            img.imageData = imageData;
            img.idx = i;
            img.alt = 'Generated image';

            // Add click event listener to image
            img.addEventListener('click', onImageClick);

            imageContainer.appendChild(img);
            imageGrid.appendChild(imageContainer);
        }

        formerPromptInput = promptInput.value

        // Hide progress indicator
        document.querySelector('.progress-bar-background').style.display = 'none';
    }

    function onRequestLoad(event) {
        const request = event.target;
        if (request.status >= 200 && request.status < 400) {
            // Success!
            const data = JSON.parse(request.response);
            updateImages(data);
        } else {
            // Error
            console.error('Error loading images');

            // Hide progress indicator
            document.querySelector('.progress-bar-background').style.display = 'none';
        }
    }

    function updateProgressBar(request, progress) {
        const progressBar = document.querySelector('.progress-bar');
        progressBar.style.width = progress + '%';
    }

    function getJobResult(jobId) {
        const request = new XMLHttpRequest();
        request.open('GET', '/get_images_result?job_id=' + jobId, true);

        request.onload = function () {
            if (request.status === 200) {
                const data = JSON.parse(request.response);
                updateImages(data);
            } else {
                // Handle error
            }
        }
        request.send();
    }

    function checkJobStatus(jobId) {
        const request = new XMLHttpRequest();
        request.open('GET', '/get_images_status/?job_id=' + jobId, true);

        request.onload = function () {
            if (request.status === 200) {
                const data = JSON.parse(request.response);
                const status = data.status;
                const progress = data.progress;
                statusText.innerText = status
                if (statusText.innerText === "running") {
                    statusText.innerText = ""
                    document.querySelector('.progress-bar-background').style.display = 'block';
                } else {
                    document.querySelector('.progress-bar-background').style.display = 'none';
                }

                console.log("job id: " + jobId + " status: " + status + " progress: " + progress);
                updateProgressBar(request, progress);
                if (status === 'finished') {
                    console.log('Job finished');
                    getJobResult(jobId);
                    document.querySelector('.progress-bar-background').style.display = 'none';
                    statusText.innerText = "Click on your favourite image"
                } else {
                    setTimeout(() => {
                        checkJobStatus(jobId);
                    }, 1000);
                }
            } else {
                // Handle error
            }
        }
        request.send();
    }

    function displayErrorMessage(message) {
        console.log("Displaying error message")
        const errorContainer = document.getElementById('error-screen');
        errorContainer.style.display = 'block';
    }

    submitButton.addEventListener('click', function () {
            document.getElementById('download-button').style.display = 'none';
            document.querySelector('.progress-bar').style.width = '0%';
            imageGridContainer.style.display = 'block';
            submitButton.style.display = 'none';
            {#clearButton.style.width = '100%';#}
            {#clearButton.style.marginRight = '0';#}

            // Send request to image service
            const request = new XMLHttpRequest();

            const requestUrl = '/get_images/?prompt=' + promptInput.value;
            request.open('POST', requestUrl, true);
            request.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');

            request.onload = function () {
                if (request.status === 200) {
                    const response = JSON.parse(request.responseText);
                    const jobId = response.jobId;
                    console.log('Job ID: ' + jobId);
                    checkJobStatus(jobId);
                } else if (request.status === 429) {
                    const errorMessage = 'Sorry, we are experiencing high traffic at the moment. Please try again in a few minutes.';
                    displayErrorMessage(errorMessage);
                } else {
                    console.log("Error: " + request.status);
                }
            };

            // Show progress indicator
            document.querySelector('.progress-bar-background').style.display = 'block';
            document.querySelector('.status-text').innerText = '';
            // Start interval to update progress bar
            updateProgressBar(request);
            request.send('prompt=' + promptInput.value);
        }
    );

    promptInput.addEventListener("keypress", function (event) {
        if (event.key === "Enter" && promptInput.value !== '' && submitButton.style.display !== 'none') {
            event.preventDefault();
            submitButton.click();
        }
    });

    downloadButton.addEventListener('click', function () {
        const clickedImage = document.querySelector('.clicked');
        const prompt = promptInput.value;
        const imageUrl = clickedImage.src;
        const imageId = clickedImage.imageId;
        const allImages = document.querySelectorAll('.image-grid img');
        const imageIds = [];

        for (let i = 0; i < allImages.length; i++) {
            imageIds.push(allImages[i].imageId);
        }

        fetch(imageUrl)
            .then(response => response.blob())
            .then(blob => {
                const file = new Blob([blob], {type: 'image/png'});
                const fileUrl = URL.createObjectURL(file);
                const a = document.createElement('a');
                a.download = promptInput.value.replace(/\s/g, '_') + '.png';
                a.href = fileUrl;
                document.body.appendChild(a);
                a.click();
                URL.revokeObjectURL(fileUrl);
            });

        fetch('/update_download_image/', {
            method: 'POST',
            body: JSON.stringify({image_uid: imageId, image_uids: imageIds, prompt: prompt}),
            headers: {
                'Content-Type': 'application/json'
            }
        }).then(response => {
            // API call success
            console.log('Successfully updated clicked image');
        }).catch(error => {
            // API call error
            console.error('Error updating clicked image:', error);
        });
    });

</script>
</body>
</html>