<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" type="text/css" href="/static/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/intro.js/6.0.0/introjs.min.css">
    <link href="/static/introjs-modern.css" rel="stylesheet">
    <title>Pick a Pic</title>
</head>
<body>

<div class="splash-screen" id="splash-screen">
    <div class="splash-screen-inner" id="intro">
        <h1>Pick a Pic</h1>
        <p>
            Pick a Pic is an app for collecting human feedback on AI-generated images for supporting academic research
            in AI. Users can generate images from text, and then rank them. Being an academic community effort, all
            <a href="https://github.com/yuvalkirstain/heroku_app" target="_blank"> code</a>, <a
                href="https://huggingface.co/datasets/yuvalkirstain/PickaPic" target="_blank"> data</a>, and models
            resulting from this research project will be completely open-sourced.
        </p>
        <div class="splash-screen-buttons">
            <button class="splash-screen-button" id="next-button-intro">Next</button>
        </div>
    </div>
    <div class="splash-screen-inner" id="legal-notice" style="display: none;">
        <h1>Legal Notice</h1>
        <ul>
            <li>This demo is intended for research purposes only.</li>
            <li>The authors are not responsible for any misuse of the demo.</li>
            <li>By using the demo, the users grant consent for their prompts, interactions, and generated images to
                be collected and eventually released into the public domain.
            </li>
        </ul>
        <div class="splash-screen-buttons">
            <button class="splash-screen-button" id="back-button" style="margin-right: 0.5vh">Back</button>
            <button class="splash-screen-button" id="next-button-legal">Accept</button>
        </div>
    </div>
    <div class="splash-screen-inner" id="google-sign-in" style="display: none;">
        <h1>Pick a Pic</h1>
        <p> To ensure that you are a real human we kindly request users to authenticate via Google before generating and
            participating in the Pick a Pic project.
        </p>
        <div class="splash-screen-buttons">
            <button class="splash-screen-button" id="google-button">Sign in with Google</button>
        </div>
    </div>
    <div class="splash-screen-inner" id="model-info" style="display: none;">
        <h1>Pick a Pic</h1>
        <li>
            <strong>Mission</strong>: We are on a mission to build the largest open-sourced and publicly available
            human-feedback for text-to-image dataset.
        </li>
        <li>
            <strong>Code</strong>: All of our code is open-source. This includes the <a
                href="https://github.com/yuvalkirstain/heroku_app" target="_blank"> web app</a> repository and the <a
                href="https://github.com/yuvalkirstain/model_app" target="_blank">model inference</a> repository.
        </li>
        <li>
            <strong>Model</strong>: Currently, we use <a href="https://huggingface.co/stabilityai/stable-diffusion-2-1"
                                                         target="_blank">
            Stable diffusion 2.1</a> and <a href="https://huggingface.co/darkstorm2150/Protogen_x3.4_Official_Release"
                                            target="_blank">
            ProtogenX3.4</a>.
        </li>
        <li>
            <strong>Data</strong>: We will update this <a href="https://huggingface.co/datasets/yuvalkirstain/PickaPic"
                                                          target="_blank">dataset</a>
            once a week with the new collected data.
        </li>
        <li>
            <strong>Reach Out</strong>: If you would like to help, suggest, or chat with us, please reach out on <a
                href="https://discord.gg/qKEVkF85DT" target="_blank">discord</a> or by <a
                href=":mailto:pickapic.io@gmail.com" target="_blank">mail</a>.
        </li>
        <div class="splash-screen-buttons">
            <button class="splash-screen-button" id="model-info-button" style="margin-right: 0.5vh">Return to demo
            </button>
        </div>
    </div>
    <div class="splash-screen-inner" id="ack-info" style="display: none;">
        <h1>Pick a Pic</h1>
        <li> We thank the <a href="https://sites.research.google/trc/about/" target="_blank">Google TRC Program</a>
            for their generous support throughout this project.
        </li>
        <div class="splash-screen-buttons">
            <button class="splash-screen-button" id="ack-info-button" style="margin-right: 0.5vh">Return to demo
            </button>
        </div>
    </div>
</div>

<div class="top-buttons">
    <a href="/logout">
        <button class="top-button" id="logout-button" title="Log out">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                 class="bi bi-box-arrow-right" viewBox="0 0 16 16">
                <path fill-rule="evenodd"
                      d="M10 12.5a.5.5 0 0 1-.5.5h-8a.5.5 0 0 1-.5-.5v-9a.5.5 0 0 1 .5-.5h8a.5.5 0 0 1 .5.5v2a.5.5 0 0 0 1 0v-2A1.5 1.5 0 0 0 9.5 2h-8A1.5 1.5 0 0 0 0 3.5v9A1.5 1.5 0 0 0 1.5 14h8a1.5 1.5 0 0 0 1.5-1.5v-2a.5.5 0 0 0-1 0v2z"/>
                <path fill-rule="evenodd"
                      d="M15.854 8.354a.5.5 0 0 0 0-.708l-3-3a.5.5 0 0 0-.708.708L14.293 7.5H5.5a.5.5 0 0 0 0 1h8.793l-2.147 2.146a.5.5 0 0 0 .708.708l3-3z"/>
            </svg>
        </button>
    </a>
    <a href="https://discord.gg/qKEVkF85DT" title="Join our discord">
        <button class="top-button">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-discord"
                 viewBox="0 0 16 16">
                <path d="M13.545 2.907a13.227 13.227 0 0 0-3.257-1.011.05.05 0 0 0-.052.025c-.141.25-.297.577-.406.833a12.19 12.19 0 0 0-3.658 0 8.258 8.258 0 0 0-.412-.833.051.051 0 0 0-.052-.025c-1.125.194-2.22.534-3.257 1.011a.041.041 0 0 0-.021.018C.356 6.024-.213 9.047.066 12.032c.001.014.01.028.021.037a13.276 13.276 0 0 0 3.995 2.02.05.05 0 0 0 .056-.019c.308-.42.582-.863.818-1.329a.05.05 0 0 0-.01-.059.051.051 0 0 0-.018-.011 8.875 8.875 0 0 1-1.248-.595.05.05 0 0 1-.02-.066.051.051 0 0 1 .015-.019c.084-.063.168-.129.248-.195a.05.05 0 0 1 .051-.007c2.619 1.196 5.454 1.196 8.041 0a.052.052 0 0 1 .053.007c.08.066.164.132.248.195a.051.051 0 0 1-.004.085 8.254 8.254 0 0 1-1.249.594.05.05 0 0 0-.03.03.052.052 0 0 0 .003.041c.24.465.515.909.817 1.329a.05.05 0 0 0 .056.019 13.235 13.235 0 0 0 4.001-2.02.049.049 0 0 0 .021-.037c.334-3.451-.559-6.449-2.366-9.106a.034.034 0 0 0-.02-.019Zm-8.198 7.307c-.789 0-1.438-.724-1.438-1.612 0-.889.637-1.613 1.438-1.613.807 0 1.45.73 1.438 1.613 0 .888-.637 1.612-1.438 1.612Zm5.316 0c-.788 0-1.438-.724-1.438-1.612 0-.889.637-1.613 1.438-1.613.807 0 1.451.73 1.438 1.613 0 .888-.631 1.612-1.438 1.612Z"/>
            </svg>
        </button>
    </a>
    <button class="top-button" onclick="activateAckInfo()" title="Acknowledgments">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
             class="bi bi-balloon-heart-fill" viewBox="0 0 16 16">
            <path fill-rule="evenodd"
                  d="M8.49 10.92C19.412 3.382 11.28-2.387 8 .986 4.719-2.387-3.413 3.382 7.51 10.92l-.234.468a.25.25 0 1 0 .448.224l.04-.08c.009.17.024.315.051.45.068.344.208.622.448 1.102l.013.028c.212.422.182.85.05 1.246-.135.402-.366.751-.534 1.003a.25.25 0 0 0 .416.278l.004-.007c.166-.248.431-.646.588-1.115.16-.479.212-1.051-.076-1.629-.258-.515-.365-.732-.419-1.004a2.376 2.376 0 0 1-.037-.289l.008.017a.25.25 0 1 0 .448-.224l-.235-.468ZM6.726 1.269c-1.167-.61-2.8-.142-3.454 1.135-.237.463-.36 1.08-.202 1.85.055.27.467.197.527-.071.285-1.256 1.177-2.462 2.989-2.528.234-.008.348-.278.14-.386Z"/>
        </svg>
    </button>
    <button class="top-button" onclick="activateLegalNotice()" title="Legal notice">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
             class="bi bi-bookmark-check" viewBox="0 0 16 16">
            <path fill-rule="evenodd"
                  d="M10.854 5.146a.5.5 0 0 1 0 .708l-3 3a.5.5 0 0 1-.708 0l-1.5-1.5a.5.5 0 1 1 .708-.708L7.5 7.793l2.646-2.647a.5.5 0 0 1 .708 0z"/>
            <path d="M2 2a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v13.5a.5.5 0 0 1-.777.416L8 13.101l-5.223 2.815A.5.5 0 0 1 2 15.5V2zm2-1a1 1 0 0 0-1 1v12.566l4.723-2.482a.5.5 0 0 1 .554 0L13 14.566V2a1 1 0 0 0-1-1H4z"/>
        </svg>
    </button>
    <button class="top-button" onclick="activateModelInfo()" title="General information">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
             class="bi bi-info-circle-fill" viewBox="0 0 16 16">
            <path d="M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16zm.93-9.412-1 4.705c-.07.34.029.533.304.533.194 0 .487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703 0-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381 2.29-.287zM8 5.5a1 1 0 1 1 0-2 1 1 0 0 1 0 2z"/>
        </svg>
    </button>
    <button class="top-button" id="user-karma-button" title="User karma">
        <div style="display: flex; align-items: center; font-size: smaller; padding: 0">
            <p id="user-score" style="margin: 0;padding: 0;">{{ user_score }}&nbsp; </p>
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                 class="bi bi-bag-heart-fill"
                 viewBox="0 0 16 16">
                <path d="M11.5 4v-.5a3.5 3.5 0 1 0-7 0V4H1v10a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V4h-3.5ZM8 1a2.5 2.5 0 0 1 2.5 2.5V4h-5v-.5A2.5 2.5 0 0 1 8 1Zm0 6.993c1.664-1.711 5.825 1.283 0 5.132-5.825-3.85-1.664-6.843 0-5.132Z"/>
            </svg>
        </div>
    </button>
</div>
<div class="container" id="top-container">
    <div class="title-button-container" style="margin-bottom: 1vmin">
        <h1 id="title" style="font-size: large;text-align: left;margin-right: 4vw;">Pick a Pic: an <a
                onclick="activateModelInfo()">open</a> dataset </h1>
        <div class="button-container">
            <button id="submit-button" title="Generate images">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-robot"
                     viewBox="0 0 16 16">
                    <path d="M6 12.5a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 0 1h-3a.5.5 0 0 1-.5-.5ZM3 8.062C3 6.76 4.235 5.765 5.53 5.886a26.58 26.58 0 0 0 4.94 0C11.765 5.765 13 6.76 13 8.062v1.157a.933.933 0 0 1-.765.935c-.845.147-2.34.346-4.235.346-1.895 0-3.39-.2-4.235-.346A.933.933 0 0 1 3 9.219V8.062Zm4.542-.827a.25.25 0 0 0-.217.068l-.92.9a24.767 24.767 0 0 1-1.871-.183.25.25 0 0 0-.068.495c.55.076 1.232.149 2.02.193a.25.25 0 0 0 .189-.071l.754-.736.847 1.71a.25.25 0 0 0 .404.062l.932-.97a25.286 25.286 0 0 0 1.922-.188.25.25 0 0 0-.068-.495c-.538.074-1.207.145-1.98.189a.25.25 0 0 0-.166.076l-.754.785-.842-1.7a.25.25 0 0 0-.182-.135Z"/>
                    <path d="M8.5 1.866a1 1 0 1 0-1 0V3h-2A4.5 4.5 0 0 0 1 7.5V8a1 1 0 0 0-1 1v2a1 1 0 0 0 1 1v1a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2v-1a1 1 0 0 0 1-1V9a1 1 0 0 0-1-1v-.5A4.5 4.5 0 0 0 10.5 3h-2V1.866ZM14 7.5V13a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V7.5A3.5 3.5 0 0 1 5.5 4h5A3.5 3.5 0 0 1 14 7.5Z"/>
                </svg>
            </button>
            <button id="download-button" style="display: none" title="Download selected image">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                     class="bi bi-download"
                     viewBox="0 0 16 16">
                    <path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/>
                    <path d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3z"/>
                </svg>
            </button>
            <button id="twitter-button" style="display: none; margin-right: 2vmin" title="Tweet selected image">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                     class="bi bi-twitter"
                     viewBox="0 0 16 16">
                    <path d="M5.026 15c6.038 0 9.341-5.003 9.341-9.334 0-.14 0-.282-.006-.422A6.685 6.685 0 0 0 16 3.542a6.658 6.658 0 0 1-1.889.518 3.301 3.301 0 0 0 1.447-1.817 6.533 6.533 0 0 1-2.087.793A3.286 3.286 0 0 0 7.875 6.03a9.325 9.325 0 0 1-6.767-3.429 3.289 3.289 0 0 0 1.018 4.382A3.323 3.323 0 0 1 .64 6.575v.045a3.288 3.288 0 0 0 2.632 3.218 3.203 3.203 0 0 1-.865.115 3.23 3.23 0 0 1-.614-.057 3.283 3.283 0 0 0 3.067 2.277A6.588 6.588 0 0 1 .78 13.58a6.32 6.32 0 0 1-.78-.045A9.344 9.344 0 0 0 5.026 15z"/>
                </svg>
            </button>
        </div>
    </div>
    <input type="search" id="prompt" placeholder="An image of...">
</div>


<div class="progress-container" style="display: block" id="progress-container">
    <div class="progress-bar-background">
        <div class="progress-bar-text"></div>
        <div class="progress-bar"></div>
    </div>
</div>
<div class="container" style="display: block" id="image-grid-container">
    <div class="image-grid">
        <div class="image-container">
            <img class="img after_clicked" src="https://loremflickr.com/512/512" id="image-grid-item-0-image"
                 style="opacity: 0">
        </div>
        <div class="image-container">
            <img class="img after_clicked" src="https://loremflickr.com/512/512" id="image-grid-item-0-image"
                 style="opacity: 0">
        </div>
        <div class="image-container">
            <img class="img after_clicked" src="https://loremflickr.com/512/512" id="image-grid-item-0-image"
                 style="opacity: 0">
        </div>
        <div class="image-container">
            <img class="img after_clicked" src="https://loremflickr.com/512/512" id="image-grid-item-0-image"
                 style="opacity: 0">
        </div>
    </div>
</div>

<div class="splash-screen" id="error-screen" style="display: none">
    <div class="splash-screen-inner" id="error">
        <h1>Pick a Pic</h1>
        <p> OMG. Given our current resources, there are too many users. Please refresh the page in one minute.</p>
    </div>
</div>

<div class="splash-screen" id="failed-screen" style="display: none">
    <div class="splash-screen-inner" id="error">
        <h1>Pick a Pic</h1>
        <p> OMG. Something went wrong. Please refresh the page and try again.</p>
    </div>
</div>

<script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/intro.js/6.0.0/intro.min.js"></script>

<script>
    {#const clearButton = document.getElementById('clear-button');#}
    const userId = {{ user_id }};
    let userScore = {{ user_score }};
    const submitButton = document.getElementById('submit-button');
    const downloadButton = document.getElementById('download-button');
    const twitterButton = document.getElementById('twitter-button');
    const promptInput = document.getElementById('prompt');
    const imageGridContainer = document.getElementById('image-grid-container');
    const imageGrid = document.querySelector('.image-grid');
    const topContainer = document.getElementById('top-container');
    const progressContainer = document.getElementById('progress-container');
    let formerPromptInput = ""
    let hasGenerated = false;

    const splashScreen = document.getElementById('splash-screen');
    const nextButtonIntro = document.getElementById('next-button-intro');
    const nextButtonLegal = document.getElementById('next-button-legal');
    const backButton = document.getElementById('back-button');
    const intro = document.getElementById('intro');
    const legalNotice = document.getElementById('legal-notice');
    const googleSignIn = document.getElementById('google-sign-in');
    const googleSignInButton = document.getElementById('google-button');
    const modelInfo = document.getElementById('model-info');
    const modelInfoButton = document.getElementById('model-info-button');
    const ackInfo = document.getElementById('ack-info');
    const ackInfoButton = document.getElementById('ack-info-button');
    const title = document.getElementById('title');
    const userKarmaButton = document.getElementById("user-karma-button");

    const introDriver = introJs();
    const blockedIds = [641, 280];

    document.getElementById("user-score").innerHTML = userScore + "&nbsp;";

    introDriver.setOptions({
        dontShowAgain: true,
        steps: [
            {
                title: 'Pick a Pic',
                intro: 'Welcome to the Pick a Pic tour. Click next to start.',
            },
            {
                element: promptInput,
                title: "Write a prompt",
                intro: "Write a description of the image you wish to generate. For example, you can write 'A mature toy poodle.'. Then, click next.",
            },
            {
                element: submitButton,
                title: "Generate images",
                intro: "Click on the Generate button or press enter. Afterward, press next.",
                position: 'left'
            },
            {
                element: progressContainer,
                title: "Generating!",
                intro: "Now the model is creating images for you. Click next once you see them.",
                position: 'top',
            },
            {
                element: imageGridContainer,
                title: "Rank!",
                intro: "Now you should click on your favorite image and we will add your feedback to the open dataset! Afterward, click next.",
                position: 'top',
            },
            {
                element: topContainer,
                title: "You are ready!!",
                intro: "Now that you have generated and ranked your first images, you can: <ul><li> download the selected image with the download button. </li><li> tweet the selected image with the twitter button. </li><li> generate more images with the generate button/enter. </li><li> change the prompt and generate new images.</li></ul> Good luck and enjoy!",
            }
        ]
    });

    introDriver.onchange(function (targetElement) {
        switch (targetElement.id) {
            case "prompt":
                promptInput.value = "A mature poodle toy.";
                break;
            case "progress-container":
                if (!hasGenerated) {
                    submitButton.click();
                }
                break;
            case "image-grid-container":
                break;
            case "top-container":
                const images = document.querySelectorAll('.image-grid img');
                if (images) {
                    const idx = Math.floor(Math.random() * images.length);
                    images.item(idx).click();
                } else {
                    introDriver.previousStep();
                }
                imageGrid.children[Math.floor(Math.random() * 4)].click();
                break;
        }
    });

    {% if is_authenticated %}
        const is_authenticated = true;
    {% else %}
        const is_authenticated = false;
    {% endif %}

    if (is_authenticated) {
        splashScreen.style.display = 'none';
        intro.style.display = 'none';
        legalNotice.style.display = 'none';
        googleSignIn.style.display = 'none';
        if (blockedIds.includes(userId)) {
            alert("You are temporarily blocked from this service due to unusual activity. Please contact us at pickapic.io@gmail.com to clarify the issue.");
            displayFailedMessage();
        }
    }

    function activateLegalNotice() {
        splashScreen.style.display = 'block';
        legalNotice.style.display = 'block';
        nextButtonLegal.innerText = 'Return to demo';
        backButton.style.display = 'none';
    }

    function activateModelInfo() {
        splashScreen.style.display = 'block';
        modelInfo.style.display = 'block';
    }

    function activateAckInfo() {
        splashScreen.style.display = 'block';
        ackInfo.style.display = 'block';
    }


    modelInfoButton.addEventListener('click', () => {
        modelInfo.style.display = 'none';
        splashScreen.style.display = 'none';
    });

    ackInfoButton.addEventListener('click', () => {
        ackInfo.style.display = 'none';
        splashScreen.style.display = 'none';
    });

    nextButtonIntro.addEventListener('click', () => {
        // Toggle the display of the legal notice
        intro.style.display = 'none';
        legalNotice.style.display = 'block';
        backButton.style.display = 'block';
    });

    nextButtonLegal.addEventListener('click', () => {
        // Toggle the display of the legal notice
        splashScreen.style.display = 'none';
        legalNotice.style.display = 'none';
        introDriver.start();
    });

    backButton.addEventListener('click', () => {
        // Toggle the display of the legal notice
        intro.style.display = 'block';
        legalNotice.style.display = 'none';
    });

    googleSignInButton.addEventListener('click', () => {
        const a = document.createElement('a');
        a.href = "/login";
        document.body.appendChild(a);
        a.click();
    });


    let img = document.querySelector('img')

    function isImage(element) {
        return element.hasOwnProperty("imageId");
    }

    function updateUserScore() {
        userKarmaButton.style.backgroundColor = "#d3b305";
        userKarmaButton.style.boxShadow = "0 0 10px gold";

        // Set a timeout to change the CSS back to its original state after 1 second
        setTimeout(function () {
            userKarmaButton.style.backgroundColor = "";
            userKarmaButton.style.boxShadow = "";
            document.getElementById("user-score").innerHTML = userScore + "&nbsp;";
        }, 1000);
    }

    function onImageClick(event) {
        const image = event.target;
        const prompt = promptInput.value;
        const allImages = document.querySelectorAll('.image-grid img');
        const imageIds = [];

        if (prompt === "") {
            alert("Please enter a prompt before clicking an image.");
            return;
        }

        {## if no images are generated#}

        for (let i = 0; i < allImages.length; i++) {
            const otherImage = allImages[i];
            if (otherImage.classList.contains('clicked')) {
                otherImage.classList.remove('clicked');
            }
            imageIds.push(otherImage.imageId);
        }
        let imageId;
        if (isImage(image)) {
            imageId = image.imageId;
            console.log('Clicked image ' + image.idx);
            downloadButton.style.display = 'inline-block';
            downloadButton.style.marginRight = '2%';
            twitterButton.style.display = 'inline-block';
            downloadButton.href = image.src;
            image.classList.add('after_clicked');
            image.classList.add('clicked');
            image.style.filter = 'brightness(100%)';
        } else {
            imageId = 'none';
            console.log('all images suck');
        }

        if (prompt !== "A mature poodle toy.") {
            fetch('/update_clicked_image/', {
                method: 'POST',
                body: JSON.stringify({image_uid: imageId, image_uids: imageIds, prompt: prompt}),
                headers: {
                    'Content-Type': 'application/json'
                }
            }).then(response => {
                // API call success
                console.log('Successfully updated clicked image');
                updateUserScore();
                userScore += 1;
            }).catch(error => {
                // API call error
                console.error('Error updating clicked image:', error);
            });
        }

        title.innerHTML = '<h1 id="title" style="font-size: large;text-align: center;">Pick a Pic</h1>'
        submitButton.style.display = 'block';
        submitButton.style.marginRight = '2%';

        // Make other images darker
        const otherImages = document.querySelectorAll('.image-grid img:not(:hover)');
        for (let i = 0; i < otherImages.length; i++) {
            const img = otherImages[i];
            if (img.classList.contains('clicked')) {
                continue;
            }
            img.style.filter = 'brightness(50%)';
            img.classList.add('after_clicked');
        }

        document.querySelector('.progress-bar-text').innerHTML = "<p></p>"
        window.scrollTo(0, 0)
    }

    function updateImages(data) {
        const images = data.images;
        const imageIds = data.image_uids;
        let clickedImage = document.querySelector('.clicked');

        // Clear current images
        while (imageGrid.firstChild) {
            imageGrid.removeChild(imageGrid.firstChild);
        }

        // Add new images
        for (let i = 0; i < images.length; i++) {

            let imageData = images[i];
            let imageId = imageIds[i];
            const imageContainer = document.createElement('div');
            imageContainer.classList.add('image-container');
            const img = document.createElement('img');
            // Keep clicked image
            if (clickedImage && i === clickedImage.idx) {# && promptInput.value === formerPromptInput) TODO new prompt --> all images are new  #} {
                imageId = clickedImage.imageId;
                imageData = clickedImage.imageData;
            }

            img.src = 'data:image/png;base64,' + imageData;
            img.imageId = imageId;
            img.imageData = imageData;
            img.idx = i;
            img.alt = 'Generated image';

            // Add click event listener to image
            img.addEventListener('click', onImageClick);

            imageContainer.appendChild(img);
            imageGrid.appendChild(imageContainer);
        }

        formerPromptInput = promptInput.value
    }

    function updateProgressBar(data) {
        const progressBar = document.querySelector('.progress-bar');
        const progressBarText = document.querySelector('.progress-bar-text');
        const status = data.status;
        const progress = data.progress;
        const progress_text = data.progress_text;
        if (status === "running") {
            progressBar.style.background = '#9fde95';
            progressBarText.innerHTML = "<p>" + progress_text + "</p>"
            progressBar.style.width = progress + '%';
        } else if (status === "queued") {
            progressBar.style.background = '#eaad67';
            progressBarText.innerHTML = "<p>" + progress_text + "</p>"
            progressBar.style.width = progress + '%';
        } else {
            progressBar.style.width = '0';
            progressBarText.innerHTML = "<p><i class='fa fa-circle-o-notch fa-spin'></i>        Uploading Images</p>"
        }
    }

    function displayErrorMessage() {
        console.log("Displaying error message")
        const errorContainer = document.getElementById('error-screen');
        errorContainer.style.display = 'block';
    }

    function displayFailedMessage() {
        console.log("Displaying error message")
        const errorContainer = document.getElementById('failed-screen');
        errorContainer.style.display = 'block';
    }

    function generate() {
        downloadButton.style.display = 'none';
        twitterButton.style.display = 'none';
        document.querySelector('.progress-bar').style.width = '0%';
        imageGridContainer.style.display = 'block';
        submitButton.style.display = 'none';
        title.innerHTML = '<h1 id="title" style="font-size: large;text-align: left;margin: 0">Pick a Pic: an <a onclick="activateModelInfo()">open</a> dataset </h1>'
        if (((promptInput.value !== "A mature poodle toy.") || (hasGenerated)) && (!is_authenticated)) {
            splashScreen.style.display = 'block';
            googleSignIn.style.display = 'block';
            return;
        }
        if (promptInput.value === "") {
            console.log("promptInput.value = " + promptInput.value)
            alert("Please enter a prompt before generating.");
            return;
        }
        hasGenerated = true;
        const hostname = window.location.hostname;
        const port = window.location.port;
        let prefix = "wss"
        if (hostname === "127.0.0.1") {
            prefix = "ws"
        }
        const websocketAddr = prefix + "://" + hostname + ":" + port + "/ws";
        let ws = new WebSocket(websocketAddr);
        ws.onmessage = function (event) {
            const data = JSON.parse(event.data);
            const status = data.status;
            updateProgressBar(data);
            if (status === 'finished' && data.images) {
                updateImages(data);
                document.querySelector('.progress-bar-text').innerHTML = "<p>Click on your favorite image. If all are <strong> bad </strong> press <a id='bad-images' href='#' onclick='javascript:onImageClick(event)'> here.</a><p>"
                document.querySelector('.progress-bar').style.width = "0";
            } else if (status === 'error') {
                displayErrorMessage();
            } else if (status === 'failed') {
                displayFailedMessage();
            }
        };

        ws.onopen = function () {
            let msg = JSON.stringify({prompt: promptInput.value, user_id: userId});
            console.log("Sending job with " + msg);
            ws.send(msg);
        };
    }

    submitButton.addEventListener('click', function () {
            generate();
        }
    );

    function submitOnEnter(event) {
        if (event.key === "Enter" && promptInput.value !== '' && submitButton.style.display !== 'none') {
            event.preventDefault();
            submitButton.click();
        }
    }

    document.addEventListener("keydown", function (event) {
        submitOnEnter(event);
    });

    downloadButton.addEventListener('click', function () {
        const clickedImage = document.querySelector('.clicked');
        const prompt = promptInput.value;
        const imageUrl = clickedImage.src;
        const imageId = clickedImage.imageId;
        const allImages = document.querySelectorAll('.image-grid img');
        const imageIds = [];

        for (let i = 0; i < allImages.length; i++) {
            imageIds.push(allImages[i].imageId);
        }

        fetch(imageUrl)
            .then(response => response.blob())
            .then(blob => {
                const file = new Blob([blob], {type: 'image/png'});
                const fileUrl = URL.createObjectURL(file);
                const a = document.createElement('a');
                a.download = promptInput.value.replace(/\s/g, '_') + '.png';
                a.href = fileUrl;
                document.body.appendChild(a);
                a.click();
                URL.revokeObjectURL(fileUrl);
            });

        fetch('/update_download_image/', {
            method: 'POST',
            body: JSON.stringify({image_uid: imageId, image_uids: imageIds, prompt: prompt}),
            headers: {
                'Content-Type': 'application/json'
            }
        }).then(response => {
            // API call success
            console.log('Successfully updated clicked image');
        }).catch(error => {
            // API call error
            console.error('Error updating clicked image:', error);
        });
    });

    twitterButton.addEventListener('click', function () {
        const clickedImage = document.querySelector('.clicked');
        const prompt = promptInput.value;
        const imageId = clickedImage.imageId;
        const imageData = clickedImage.imageData;

        fetch('/tweet/', {
            method: 'POST',
            body: JSON.stringify({image_uid: imageId, prompt: prompt, image_data: imageData, user_id: userId}),
            headers: {
                'Content-Type': 'application/json'
            }
        }).then(response => {
            // API call success
            response.json().then(data => {
                const tweetText = data.tweet_text;
                const a = document.createElement('a');
                console.log("tweetText = " + tweetText);
                a.href = "https://twitter.com/intent/tweet?url=" + tweetText;
                console.log("a.href = " + a.href);
                a.target = "_blank";
                document.body.appendChild(a);
                a.click();
                console.log('Successfully tweeted image');
            });
        }).catch(error => {
            // API call error
            console.error('Error updating clicked image:', error);
        });
    });


    function clearDemo() {
        const progressBarText = document.querySelector('.progress-bar-text');
        const title = document.getElementById('title');
        const submitButton = document.getElementById('submit-button');
        const imageContainerChildren = imageGrid.children;

        progressBarText.innerHTML = "<p></p>"
        title.innerHTML = '<h1 id="title" style="font-size: large;text-align: left;margin: 0">Pick a Pic: an <a onclick="activateModelInfo()">open</a> dataset </h1>'
        submitButton.style.display = 'block';
        submitButton.style.marginRight = '2%';

        for (let i = 0; i < imageContainerChildren.length; i++) {
            const imageChildren = imageContainerChildren[i].children;
            for (let j = 0; j < imageChildren.length; j++) {
                const image = imageChildren[j];
                image.style.opacity = 0;
                image.classList.add('after_clicked');
                if (image.classList.contains('clicked')) {
                    image.classList.remove('clicked');
                }
            }
        }
    }

    document.getElementById("prompt").addEventListener("search", function (event) {
        clearDemo();
    });

</script>
</body>
</html>