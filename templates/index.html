<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" type="text/css" href="/static/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/intro.js/6.0.0/introjs.min.css">
    <link href="/static/introjs-modern.css" rel="stylesheet">
    <title>Pick a Pic</title>
</head>
<body>

<div class="splash-screen" id="splash-screen">
    <div class="splash-screen-inner" id="intro">
        <h1>Pick a Pic</h1>
        <p>
            Pick a Pic is an app for collecting human feedback on AI-generated images for supporting academic research
            in AI. Users can generate images from text, and then rank them. Being an academic community effort, all
            <a href="https://github.com/yuvalkirstain/heroku_app" target="_blank"> code</a>, <a
                href="https://huggingface.co/datasets/yuvalkirstain/PickaPic" target="_blank"> data</a>, and models
            resulting from this research project will be completely open-sourced.
        </p>
        <div class="splash-screen-buttons">
            <button class="splash-screen-button" id="next-button-intro">Next</button>
        </div>
    </div>
    <div class="splash-screen-inner" id="legal-notice" style="display: none;">
        <h1>Legal Notice</h1>
        <ul>
            <li>This demo is intended for research purposes only.</li>
            <li>The authors are not responsible for any misuse of the demo.</li>
            <li>By using the demo, the users grant consent for their prompts, interactions, and generated images to
                be collected and eventually released into the public domain.
            </li>
            <li>By using the demo, the users agree not to generate content that others may find to be offensive, upsetting, or inappropriate.</li>
        </ul>
        <div class="splash-screen-buttons">
            <button class="splash-screen-button" id="back-button" style="margin-right: 0.5vh">Back</button>
            <button class="splash-screen-button" id="next-button-legal">Accept</button>
        </div>
    </div>
    <div class="splash-screen-inner" id="sign-in" style="display: none;">
        <h1>Pick a Pic</h1>
        <p> To ensure that you are a real human we kindly request users to authenticate via Google or Discord before
            generating and participating in the Pick a Pic project.
        </p>
        <div class="splash-screen-buttons">
            <button class="splash-screen-button" id="close-button" style="margin-right: 0.5vh">Close</button>
            <button class="splash-screen-button" id="google-button" style="margin-right: 0.5vh">Google Sign in</button>
            <button class="splash-screen-button" id="discord-button" style="margin-right: 0">Discord Sign in</button>
        </div>
    </div>
    <div class="splash-screen-inner" id="model-info" style="display: none;">
        <h1>Pick a Pic</h1>
        <li style="font-size: min(3.0vmin, 18px);">
            <strong>Mission</strong>: We are on a mission to build the largest open-sourced and publicly available
            human-feedback for text-to-image dataset.
        </li>
        <li style="font-size: min(3.0vmin, 18px);">
            <strong>Code</strong>: All of our code is open-source. This includes the <a
                href="https://github.com/yuvalkirstain/heroku_app" target="_blank"> web app</a> repository and the <a
                href="https://github.com/yuvalkirstain/model_app" target="_blank">model inference</a> repository.
        </li>
        <li style="font-size: min(3.0vmin, 18px);">
            <strong>Model</strong>: Currently, we use <a href="https://huggingface.co/stabilityai/stable-diffusion-2-1"
                                                         target="_blank">
            SD 2.1</a>, <a href="https://huggingface.co/dreamlike-art/dreamlike-photoreal-2.0"
                                            target="_blank">
            dreamlike-photoreal-2.0</a>, SDXL 2.2 alpha, and SDXL 2.2 beta.
        </li>
        <li style="font-size: min(3.0vmin, 18px);">
            <strong>Data</strong>: We will periodically update this <a
                href="https://huggingface.co/datasets/yuvalkirstain/PickaPic"
                target="_blank">dataset</a>
            with the new collected data.
        </li>
        <li style="font-size: min(3.0vmin, 18px);">
            <strong>Reach Out</strong>: If you would like to help, suggest, or chat with us, please reach out on <a
                href="https://discord.gg/qKEVkF85DT" target="_blank">discord</a> or by <a
                href=":mailto:pickapic.io@gmail.com" target="_blank">mail</a>.
        </li>
        <li style="font-size: min(3.0vmin, 18px);">
            <strong>Negative Prompts</strong>: Inside square brackets. E.g. "Hello [world]" will result in the prompt:
            "Hello" and negative prompt "world".
        </li>
        <div class="splash-screen-buttons">
            <button class="splash-screen-button" id="model-info-button" style="margin-right: 0.5vh">Return to demo
            </button>
        </div>
    </div>
    <div class="splash-screen-inner" id="ack-info" style="display: none;">
        <h1>Pick a Pic</h1>
        We thank <a href="https://stability.ai/" target="_blank">StabilityAI</a> and the <a href="https://sites.research.google/trc/about/" target="_blank">Google TRC Program</a>
            for their generous support throughout this project.
        <div class="splash-screen-buttons">
            <button class="splash-screen-button" id="ack-info-button" style="margin-right: 0.5vh">Return to demo
            </button>
        </div>
    </div>
</div>

<div class="top-buttons">
    <button class="top-button" id="logout-button" title="Log out">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
             class="bi bi-door-closed-fill" viewBox="0 0 16 16">
            <path d="M12 1a1 1 0 0 1 1 1v13h1.5a.5.5 0 0 1 0 1h-13a.5.5 0 0 1 0-1H3V2a1 1 0 0 1 1-1h8zm-2 9a1 1 0 1 0 0-2 1 1 0 0 0 0 2z"/>
        </svg>
    </button>
    <a href="https://discord.gg/qKEVkF85DT" title="Join our discord">
        <button class="top-button">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-discord"
                 viewBox="0 0 16 16">
                <path d="M13.545 2.907a13.227 13.227 0 0 0-3.257-1.011.05.05 0 0 0-.052.025c-.141.25-.297.577-.406.833a12.19 12.19 0 0 0-3.658 0 8.258 8.258 0 0 0-.412-.833.051.051 0 0 0-.052-.025c-1.125.194-2.22.534-3.257 1.011a.041.041 0 0 0-.021.018C.356 6.024-.213 9.047.066 12.032c.001.014.01.028.021.037a13.276 13.276 0 0 0 3.995 2.02.05.05 0 0 0 .056-.019c.308-.42.582-.863.818-1.329a.05.05 0 0 0-.01-.059.051.051 0 0 0-.018-.011 8.875 8.875 0 0 1-1.248-.595.05.05 0 0 1-.02-.066.051.051 0 0 1 .015-.019c.084-.063.168-.129.248-.195a.05.05 0 0 1 .051-.007c2.619 1.196 5.454 1.196 8.041 0a.052.052 0 0 1 .053.007c.08.066.164.132.248.195a.051.051 0 0 1-.004.085 8.254 8.254 0 0 1-1.249.594.05.05 0 0 0-.03.03.052.052 0 0 0 .003.041c.24.465.515.909.817 1.329a.05.05 0 0 0 .056.019 13.235 13.235 0 0 0 4.001-2.02.049.049 0 0 0 .021-.037c.334-3.451-.559-6.449-2.366-9.106a.034.034 0 0 0-.02-.019Zm-8.198 7.307c-.789 0-1.438-.724-1.438-1.612 0-.889.637-1.613 1.438-1.613.807 0 1.45.73 1.438 1.613 0 .888-.637 1.612-1.438 1.612Zm5.316 0c-.788 0-1.438-.724-1.438-1.612 0-.889.637-1.613 1.438-1.613.807 0 1.451.73 1.438 1.613 0 .888-.631 1.612-1.438 1.612Z"/>
            </svg>
        </button>
    </a>
    <button class="top-button" onclick="activateAckInfo()" title="Acknowledgments">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
             class="bi bi-balloon-heart-fill" viewBox="0 0 16 16">
            <path fill-rule="evenodd"
                  d="M8.49 10.92C19.412 3.382 11.28-2.387 8 .986 4.719-2.387-3.413 3.382 7.51 10.92l-.234.468a.25.25 0 1 0 .448.224l.04-.08c.009.17.024.315.051.45.068.344.208.622.448 1.102l.013.028c.212.422.182.85.05 1.246-.135.402-.366.751-.534 1.003a.25.25 0 0 0 .416.278l.004-.007c.166-.248.431-.646.588-1.115.16-.479.212-1.051-.076-1.629-.258-.515-.365-.732-.419-1.004a2.376 2.376 0 0 1-.037-.289l.008.017a.25.25 0 1 0 .448-.224l-.235-.468ZM6.726 1.269c-1.167-.61-2.8-.142-3.454 1.135-.237.463-.36 1.08-.202 1.85.055.27.467.197.527-.071.285-1.256 1.177-2.462 2.989-2.528.234-.008.348-.278.14-.386Z"/>
        </svg>
    </button>
    <button class="top-button" onclick="activateLegalNotice()" title="Legal notice">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
             class="bi bi-bookmark-check-fill" viewBox="0 0 16 16">
            <path fill-rule="evenodd"
                  d="M2 15.5V2a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v13.5a.5.5 0 0 1-.74.439L8 13.069l-5.26 2.87A.5.5 0 0 1 2 15.5zm8.854-9.646a.5.5 0 0 0-.708-.708L7.5 7.793 6.354 6.646a.5.5 0 1 0-.708.708l1.5 1.5a.5.5 0 0 0 .708 0l3-3z"/>
        </svg>
    </button>
    <button class="top-button" onclick="activateModelInfo()" title="General information">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
             class="bi bi-info-circle-fill" viewBox="0 0 16 16">
            <path d="M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16zm.93-9.412-1 4.705c-.07.34.029.533.304.533.194 0 .487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703 0-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381 2.29-.287zM8 5.5a1 1 0 1 1 0-2 1 1 0 0 1 0 2z"/>
        </svg>
    </button>
    <button class="top-button" id="user-karma-button" title="User karma" style="margin-right: 0; margin-left: auto">
        <div style="display: flex; align-items: center; font-size: smaller; padding: 0">
            <p id="user-score" style="margin: 0;padding: 0;">{{ user_score }}&nbsp; </p>
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                 class="bi bi-bag-heart-fill"
                 viewBox="0 0 16 16">
                <path d="M11.5 4v-.5a3.5 3.5 0 1 0-7 0V4H1v10a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V4h-3.5ZM8 1a2.5 2.5 0 0 1 2.5 2.5V4h-5v-.5A2.5 2.5 0 0 1 8 1Zm0 6.993c1.664-1.711 5.825 1.283 0 5.132-5.825-3.85-1.664-6.843 0-5.132Z"/>
            </svg>
        </div>
    </button>
</div>
<div class="container" id="top-container">
    <div class="title-button-container" style="margin-bottom: 1vmin">
        <h1 id="title" style="font-size: large;text-align: left;margin-right: 4vw;">Pick a Pic: an <a
                onclick="activateModelInfo()">open</a> dataset </h1>
        <div class="button-container">
            <button style="margin-right: 2%; display: flex;" title="Automatically show the next image after ranking.">
                <label for="automode"><input type="checkbox" id="automode" name="automode" value="yes" checked>Auto</label>
            </button>
            <button id="submit-button" title="Generate images">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                     class="bi bi-play-fill" viewBox="0 0 16 16">
                    <path d="m11.596 8.697-6.363 3.692c-.54.313-1.233-.066-1.233-.697V4.308c0-.63.692-1.01 1.233-.696l6.363 3.692a.802.802 0 0 1 0 1.393z"/>
                </svg>
            </button>
            <button id="download-button" style="display: none" title="Download selected image">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                     class="bi bi-download"
                     viewBox="0 0 16 16">
                    <path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/>
                    <path d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3z"/>
                </svg>
            </button>
            <button id="twitter-button" style="display: none; margin-right: 2vmin" title="Tweet selected image">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                     class="bi bi-twitter"
                     viewBox="0 0 16 16">
                    <path d="M5.026 15c6.038 0 9.341-5.003 9.341-9.334 0-.14 0-.282-.006-.422A6.685 6.685 0 0 0 16 3.542a6.658 6.658 0 0 1-1.889.518 3.301 3.301 0 0 0 1.447-1.817 6.533 6.533 0 0 1-2.087.793A3.286 3.286 0 0 0 7.875 6.03a9.325 9.325 0 0 1-6.767-3.429 3.289 3.289 0 0 0 1.018 4.382A3.323 3.323 0 0 1 .64 6.575v.045a3.288 3.288 0 0 0 2.632 3.218 3.203 3.203 0 0 1-.865.115 3.23 3.23 0 0 1-.614-.057 3.283 3.283 0 0 0 3.067 2.277A6.588 6.588 0 0 1 .78 13.58a6.32 6.32 0 0 1-.78-.045A9.344 9.344 0 0 0 5.026 15z"/>
                </svg>
            </button>
        </div>
    </div>
    <div style="display:flex">
        <button id="reset" onclick="clearDemo()"
                style="padding: 0; margin-bottom: 1vmin; margin-right: 1vmin; background-color: transparent; color: white"
                title="Try a different prompt">Clear
            {#            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-trash3-fill"#}
            {#                 viewBox="0 0 16 16">#}
            {#                <path d="M11 1.5v1h3.5a.5.5 0 0 1 0 1h-.538l-.853 10.66A2 2 0 0 1 11.115 16h-6.23a2 2 0 0 1-1.994-1.84L2.038 3.5H1.5a.5.5 0 0 1 0-1H5v-1A1.5 1.5 0 0 1 6.5 0h3A1.5 1.5 0 0 1 11 1.5Zm-5 0v1h4v-1a.5.5 0 0 0-.5-.5h-3a.5.5 0 0 0-.5.5ZM4.5 5.029l.5 8.5a.5.5 0 1 0 .998-.06l-.5-8.5a.5.5 0 1 0-.998.06Zm6.53-.528a.5.5 0 0 0-.528.47l-.5 8.5a.5.5 0 0 0 .998.058l.5-8.5a.5.5 0 0 0-.47-.528ZM8 4.5a.5.5 0 0 0-.5.5v8.5a.5.5 0 0 0 1 0V5a.5.5 0 0 0-.5-.5Z"/>#}
            {#            </svg>#}

        </button>
        <input type="text" id="prompt" placeholder=" An image of...">
    </div>
</div>


<div class="progress-container" style="display: block" id="progress-container">
    <div class="progress-bar-background">
        <div class="progress-bar"></div>
        <div class="progress-bar-text"></div>
    </div>
</div>
<div class="container" style="display: block" id="image-grid-container">
    <div class="image-grid">
        <div class="image-container">
            <img class="img after_clicked" src="https://loremflickr.com/512/512" id="image-grid-item-0-image"
                 style="opacity: 0">
        </div>
        <div class="image-container">
            <img class="img after_clicked" src="https://loremflickr.com/512/512" id="image-grid-item-0-image"
                 style="opacity: 0">
        </div>
    </div>
</div>
<button style="width: 100%; display: none; margin-top: 2vmin; height: 20vmin; color: #ec6565; font-size: 3vmin"
        id="same-button" href='#' onclick='javascript:onImageClick(event)'> No image is significantly better than the
    other
</button>

<div class="splash-screen" id="error-screen" style="display: none">
    <div class="splash-screen-inner" id="error">
        <h1>Pick a Pic</h1>
        <p> OMG. Given our current resources, there are too many users. Please refresh the page in one minute.</p>
    </div>
</div>

<div class="splash-screen" id="user-limit" style="display: none">
    <div class="splash-screen-inner" id="error">
        <h1>Pick a Pic</h1>
        <p> We are currently limiting the number of generations per user to 1500. We might increase it in the future. For any questions, please contact us at <a
                    href=":mailto:pickapic.io@gmail.com" target="_blank">mail</a>.</p>
    </div>
</div>

<div class="splash-screen" id="failed-screen" style="display: none">
    <div class="splash-screen-inner" id="error">
        <h1>Pick a Pic</h1>
        <p> OMG. Something went wrong. Please refresh the page and try again.</p>
    </div>
</div>

<script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/intro.js/6.0.0/intro.min.js"></script>

<script>
    {#const clearButton = document.getElementById('clear-button');#}
    const userId = {{ user_id }};
    let userScore = {{ user_score }};
    const submitButton = document.getElementById('submit-button');
    const downloadButton = document.getElementById('download-button');
    const twitterButton = document.getElementById('twitter-button');
    const promptInput = document.getElementById('prompt');
    const imageGridContainer = document.getElementById('image-grid-container');
    const imageGrid = document.querySelector('.image-grid');
    const topContainer = document.getElementById('top-container');
    const progressContainer = document.getElementById('progress-container');
    let formerPromptInput = ""
    let hasGenerated = false;

    const splashScreen = document.getElementById('splash-screen');
    const nextButtonIntro = document.getElementById('next-button-intro');
    const nextButtonLegal = document.getElementById('next-button-legal');
    const backButton = document.getElementById('back-button');
    const intro = document.getElementById('intro');
    const legalNotice = document.getElementById('legal-notice');
    const SignIn = document.getElementById('sign-in');
    const googleSignInButton = document.getElementById('google-button');
    const discordSignInButton = document.getElementById('discord-button');
    const logoutButton = document.getElementById('logout-button');
    const closeButton = document.getElementById('close-button');
    const modelInfo = document.getElementById('model-info');
    const modelInfoButton = document.getElementById('model-info-button');
    const ackInfo = document.getElementById('ack-info');
    const ackInfoButton = document.getElementById('ack-info-button');
    const title = document.getElementById('title');
    const userKarmaButton = document.getElementById("user-karma-button");
    const cachedImages = [];
    const numImagesForDisplay = 2;
    const progressBar = document.querySelector('.progress-bar');
    const progressBarText = document.querySelector('.progress-bar-text');
    const neitherButton = document.getElementById('same-button');
    const autoMode = document.querySelector('#automode');
    let wasClicked = false;

    const introDriver = introJs();
    const blockedIds = [
        280, 331, 437, 641, 718, 729, 783, 984, 1023, 1040, 1059, 1149, 1187, 1177, 1202, 1203, 1220,
        1230, 1227, 1279, 1405, 1460, 1585, 1623, 1627, 1758, 1801, 1907, 1917, 1922, 1923, 2071, 2215, 2239, 2286,
        2322, 2357, 2452, 2459, 2481, 2513, 2515, 2520, 2545, 2596, 2603, 2617, 2638, 2667, 2709, 2771, 2783, 2842,
        2266, 2899, 2905, 3084, 3138, 3243, 3264, 3265, 3267, 3251, 3292, 3268, 3271, 1961, 3302, 3318, 1689, 3278,
        1382, 3542, 3446, 3633, 1526, 4710, 4748, 4762, 4444, 4870, 4733, 4878
    ];
    const nsfwWords = ["seductive", "sexy", "nude", "naked", "nudity", "nakedness", "nakedly", "nakedness",
        "busty", "boobs", "shirtless", "nude", "revealing", "naked", "breast", "amouranth",
        "nigger", "sussy", "tits", "lingerie", "sex", "bikini", "putin", "nazi", "underwear", "stomach", "xi jinping",
        "thong", "fuck", "lola myluv", "elsa jean", "porn", "courtesan", "b00bs", "undressed", " anal ", "blowjo", "p0rn",
        "sxy", "blowjo", "cumshot", "vagina", "horny", " ass", "pussy", "onlyfans", "(", ")", "--", "crotch",
        "gagg", "nudist", "lecherous", "voluptuous", "buxom", "lustful", "genitals", "nymph", "camgirl", "exposed",
        "babe", "{", "}", "hitler", "nakey", "suck", "blowjob", "unclothed", "wearing nothing", "breasted",
        "nsfw", "erotic", "hentai", "topless", "nipple", "without clothes", "playboy", "bøøbs", "booty", "leotard",
        "nudist", "scantily clad", "salacious", "minimal clothes", "see through", "bulge", "onahole",
        "loincloth", "man posing", "jockstrap", " bra ", "shower", "femdom", "harvey weinstein",
        "emma watson", "curvaceous", "sensuous", "chest", "no clothes", "scantily", "undies", "bulging", "swimsuit",
        "belly", "sweatpants", "suntanning", "naughty", "jada stevens", "cleavage", " panty", " virgin",
        "pusy", "catgirl", "nue ", " nue", "_", "trump", "/", "loli", "shota", "futanari", "hentai", "ecchi",
        "camboy", "catboy", "without cloth", "::", "unclothes", "no clothing", "bare skin", "bareskinned", "hunk",
        "pubes"
    ];

    document.getElementById("user-score").innerHTML = userScore + "&nbsp;";

    const possiblePrompts = [
        "Giant caterpillar riding a bicycle",
        "Fantasy castle on a hilltop",
        "Giant ice cream cone melting and creating a river through a city",
        "Glamorous dressing room with large mirror",
        "Beautiful Venice canals with gondolas and bridges",
        "Traditional library with floor-to-ceiling bookcases",
        "Sturdy and pink pickup truck",
        "Mystical forest with glowing mushrooms and a babbling brook",
        "Gothic cathedral in a stormy night",
        "beautiful building portrait",
        "a cat driving a car",
        "a dog riding bicycle",
        "A sign that says PICK A PIC",
        "a car that is made out of wood",
        "a Ferrari car that is made out of wood",
        "A panda bear as a mad scientist",
        "A steampunk octopus in a futuristic cityscape!",
        "A mermaid playing chess with a dolphin",
        "A gijinka black cat sushi chef",
        "Photo of a pigeon in a well tailored suit getting a cup of coffee in a cafe in the morning",
        "Two cats playing chess on a tree branch",
        "a shadow of a man standing in the dark, cyanotype",
        "Sunset reflecting on a crystal ball",
        "A cat on a propaganda poster",
        "An evil villain holding a mini Earth",
        "A curious cat exploring a haunted mansion",
        "art poster, the essence of charcoal painting, a jedi silhouette with a lightsaber on a mountain landscape by J. M. W. Turner and bob ross, charcoal painting",
        "Astronaut in a massive colorful space",
        "cinematic still of a stainless steel robot swimming in a pool",
        "cinematic still of highly reflective stainless steel train in the desert, at sunset",
        "Cute grey cat, digital oil painting by Monet",
        "photo of a dragon cooking dinner",
        "A cyberpunk golden retriever is coding",
    ]
    promptInput.value = possiblePrompts[Math.floor(Math.random() * possiblePrompts.length)];

    introDriver.setOptions({
        dontShowAgain: true,
        steps: [
            {
                title: 'Pick a Pic',
                intro: 'Welcome to the Pick a Pic tour. Click next to start.',
            },
            {
                element: promptInput,
                title: "Write a prompt",
                intro: "Write a description of the image you wish to generate. For example, you can write 'A mature toy poodle.'. Then, click next.",
            },
            {
                element: submitButton,
                title: "Generate images",
                intro: "Click on the Generate button or press enter. Afterward, press next.",
                position: 'left'
            },
            {
                element: progressContainer,
                title: "Generating!",
                intro: "Now the model is creating images for you. Click next once you see them.",
                position: 'top',
            },
            {
                element: imageGridContainer,
                title: "Rank!",
                intro: "Now you should click on your favorite image, or click that no image is significantly better than the other. Afterward, click next.",
                position: 'top',
            },
            {
                element: topContainer,
                title: "You are ready!!",
                intro: "Now that you have generated and ranked your first images, you can: <ul><li> download the selected image with the download button. </li><li> tweet the selected image with the twitter button. </li><li> generate more images with the generate button/enter. </li><li> change the prompt and generate new images.</li><li> check the automode button to automatically see the next image.</li></ul> Good luck and enjoy!",
            }
        ]
    });

    introDriver.onchange(function (targetElement) {
        switch (targetElement.id) {
            case "prompt":
                promptInput.value = "A mature poodle toy.";
                break;
            case "progress-container":
                if (!hasGenerated) {
                    submitButton.click();
                }
                break;
            case "image-grid-container":
                break;
            case "top-container":
                const images = document.querySelectorAll('.image-grid img');
                if (images) {
                    const idx = Math.floor(Math.random() * images.length);
                    images.item(idx).click();
                } else {
                    introDriver.previousStep();
                }
                imageGrid.children[Math.floor(Math.random() * 4)].click();
                break;
        }
    });

    {% if is_authenticated %}
        const is_authenticated = true;
    {% else %}
        const is_authenticated = false;
    {% endif %}

    if (!is_authenticated) {
        logoutButton.title = "Log in";
    }

    logoutButton.addEventListener('click', () => {

        if (is_authenticated) {
            const a = document.createElement('a');
            a.href = "/logout";
            document.body.appendChild(a);
            a.click();
        } else {
            splashScreen.style.display = 'block';
            SignIn.style.display = 'block';
        }
    });


    if (is_authenticated) {
        splashScreen.style.display = 'none';
        intro.style.display = 'none';
        legalNotice.style.display = 'none';
        SignIn.style.display = 'none';
        if (blockedIds.includes(userId)) {
            alert("You are temporarily blocked from this service due to unusual activity. Please contact us at pickapic.io@gmail.com to clarify the issue.");
            displayFailedMessage();
        }
    }

    function activateLegalNotice() {
        splashScreen.style.display = 'block';
        legalNotice.style.display = 'block';
        nextButtonLegal.innerText = 'Return to demo';
        backButton.style.display = 'none';
    }

    function activateModelInfo() {
        splashScreen.style.display = 'block';
        modelInfo.style.display = 'block';
    }

    function activateAckInfo() {
        splashScreen.style.display = 'block';
        ackInfo.style.display = 'block';
    }


    modelInfoButton.addEventListener('click', () => {
        modelInfo.style.display = 'none';
        splashScreen.style.display = 'none';
    });

    ackInfoButton.addEventListener('click', () => {
        ackInfo.style.display = 'none';
        splashScreen.style.display = 'none';
    });

    nextButtonIntro.addEventListener('click', () => {
        // Toggle the display of the legal notice
        intro.style.display = 'none';
        legalNotice.style.display = 'block';
        backButton.style.display = 'block';
    });

    nextButtonLegal.addEventListener('click', () => {
        // Toggle the display of the legal notice
        splashScreen.style.display = 'none';
        legalNotice.style.display = 'none';
        introDriver.start();
    });

    backButton.addEventListener('click', () => {
        // Toggle the display of the legal notice
        intro.style.display = 'block';
        legalNotice.style.display = 'none';
    });

    googleSignInButton.addEventListener('click', () => {
        const a = document.createElement('a');
        a.href = "/login";
        document.body.appendChild(a);
        a.click();
    });

    discordSignInButton.addEventListener('click', () => {
        const a = document.createElement('a');
        a.href = "/discord_login";
        document.body.appendChild(a);
        a.click();
    });


    let img = document.querySelector('img')

    function isImage(element) {
        return element.hasOwnProperty("imageId");
    }

    function updateUserScore() {
        userKarmaButton.style.backgroundColor = "#d3b305";
        userKarmaButton.style.boxShadow = "0 0 10px gold";

        // Set a timeout to change the CSS back to its original state after 1 second
        setTimeout(function () {
            userKarmaButton.style.backgroundColor = "";
            userKarmaButton.style.boxShadow = "";
            document.getElementById("user-score").innerHTML = userScore + "&nbsp;";
        }, 1000);
    }

    function prepareProgressBarTextForRanking() {
        progressBarText.innerHTML = "<p>Click on the better image or button below.<p>";
        neitherButton.style.display = 'block';
    }

    function prepareProgressBarTextForUploadingImages() {
        progressBarText.innerHTML = "<p><i class='fa fa-circle-o-notch fa-spin'></i>        Processing Images</p>";
    }

    function onImageClick(event) {
        if (wasClicked) {
            return;
        }

        const image = event.target;
        const prompt = formerPromptInput;
        const allImages = document.querySelectorAll('.image-grid img');
        const imageIds = [];

        {## if no images are generated#}

        for (let i = 0; i < allImages.length; i++) {
            const otherImage = allImages[i];
            if (otherImage.classList.contains('clicked')) {
                otherImage.classList.remove('clicked');
            }
            imageIds.push(otherImage.imageId);
        }
        let imageId;
        if (isImage(image)) {
            imageId = image.imageId;
            console.log('Clicked image ' + image.idx);
            downloadButton.style.display = 'inline-block';
            downloadButton.style.marginRight = '2%';
            twitterButton.style.display = 'inline-block';
            downloadButton.href = image.src;
            image.classList.add('after_clicked');
            image.classList.add('clicked');
            image.style.filter = 'brightness(100%)';
        } else {
            imageId = 'none';
            // Make a random image clicked so we do not replace both
            const randomImage = allImages[Math.floor(Math.random() * allImages.length)];
            randomImage.classList.add('clicked');
        }

        if (prompt !== "A mature poodle toy.") {
            fetch('/update_clicked_image/', {
                method: 'POST',
                body: JSON.stringify({image_uid: imageId, image_uids: imageIds, prompt: prompt}),
                headers: {
                    'Content-Type': 'application/json'
                }
            }).then(response => {
                // API call success
                console.log('Successfully updated clicked image');
                updateUserScore();
                userScore += 1;
            }).catch(error => {
                // API call error
                console.error('Error updating clicked image:', error);
            });
        }

        title.innerHTML = '<h1 id="title" style="font-size: large;text-align: center;">Pick a Pic</h1>'
        submitButton.style.display = 'block';
        submitButton.style.marginRight = '2%';

        // Make other images darker
        const otherImages = document.querySelectorAll('.image-grid img:not(:hover)');
        for (let i = 0; i < otherImages.length; i++) {
            const img = otherImages[i];
            if (img.classList.contains('clicked')) {
                continue;
            }
            img.style.filter = 'brightness(50%)';
            img.classList.add('after_clicked');
        }

        document.querySelector('.progress-bar-text').innerHTML = "<p></p>"
        window.scrollTo(0, 0)
        wasClicked = true;
        progressBarText.innerHTML = "<p>Great! Press play to generate more!<p>";
        // This allows us to show next image right away. cachedImages.length > 0 &&
        if (is_authenticated && autoMode.checked) {
            generate();
            prepareProgressBarTextForRanking();
            {#prepareProgressBarTextForUploadingImages();#}
            {#setTimeout(function () {#}
            {#    generate();#}
            {#    prepareProgressBarTextForRanking();#}
            {# }, 500);#}
        }
    }

    function updateImages(data) {
        const images = data.images;
        const imageIds = data.image_uids;

        // Shuffle images
        let index = images.length;
        let rnd, tmp1, tmp2;

        while (index) {
            rnd = Math.floor(Math.random() * index);
            index -= 1;
            tmp1 = images[index];
            tmp2 = imageIds[index];
            images[index] = images[rnd];
            imageIds[index] = imageIds[rnd];
            images[rnd] = tmp1;
            imageIds[rnd] = tmp2;
        }

        let clickedImage = document.querySelector('.clicked');

        // Clear current images
        while (imageGrid.firstChild) {
            imageGrid.removeChild(imageGrid.firstChild);
        }
        if (clickedImage !== null && formerPromptInput === promptInput.value) {
            const imageContainer = document.createElement('div');
            imageContainer.classList.add('image-container');
            imageContainer.appendChild(clickedImage);
            imageGrid.appendChild(imageContainer);
        }

        // Add new images
        for (let i = 0; i < images.length; i++) {

            let imageData = images[i];
            let imageId = imageIds[i];
            const imageContainer = document.createElement('div');
            imageContainer.classList.add('image-container');
            const img = document.createElement('img');

            img.src = 'data:image/png;base64,' + imageData;
            img.imageId = imageId;
            img.imageData = imageData;
            img.idx = i;
            img.alt = 'Generated image';

            // Add click event listener to image
            img.addEventListener('click', onImageClick);
            imageContainer.appendChild(img);
            if (imageGrid.children.length < numImagesForDisplay) {
                imageGrid.appendChild(imageContainer);
            } else {
                cachedImages.push(imageContainer);
            }
        }

        formerPromptInput = promptInput.value
    }

    function showProgress(progress, progress_text) {
        neitherButton.style.display = 'none';
        progressBar.style.width = progress + '%';
        progressBarText.innerHTML = "<p style='text-align: center; position: absolute; top: 0;'>" + progress_text + "</p>"
    }

    function updateProgressBar(data) {
        const status = data.status;
        const progress = data.progress;
        const progress_text = data.progress_text;
        if (status === "running") {
            progressBar.style.background = '#9fde95';
            showProgress(progress, progress_text);
        } else if (status === "queued") {
            progressBar.style.background = '#eaad67';
            showProgress(progress, progress_text);
        } else {
            progressBar.style.width = '0';
            prepareProgressBarTextForUploadingImages();
        }
    }

    function displayErrorMessage() {
        console.log("Displaying error message")
        const errorContainer = document.getElementById('error-screen');
        errorContainer.style.display = 'block';
    }

    function displayFailedMessage() {
        console.log("Displaying error message")
        const errorContainer = document.getElementById('failed-screen');
        errorContainer.style.display = 'block';
    }

    function onPromptInput() {
        if (((promptInput.value !== "A mature poodle toy.") || (hasGenerated)) && (!is_authenticated)) {
            splashScreen.style.display = 'block';
            SignIn.style.display = 'block';
        }
    }

    closeButton.addEventListener('click', () => {
        splashScreen.style.display = 'none';
        SignIn.style.display = 'none';
    });

    promptInput.addEventListener('input', onPromptInput);

    function generate() {
        wasClicked = false;
        console.log("Generating")
        downloadButton.style.display = 'none';
        twitterButton.style.display = 'none';
        document.querySelector('.progress-bar').style.width = '0%';
        imageGridContainer.style.display = 'block';
        submitButton.style.display = 'none';
        title.innerHTML = '<h1 id="title" style="font-size: large;text-align: left;margin: 0">Pick a Pic: an <a onclick="activateModelInfo()">open</a> dataset </h1>'
        if (((promptInput.value !== "A mature poodle toy.") || (hasGenerated)) && (!is_authenticated)) {
            splashScreen.style.display = 'block';
            SignIn.style.display = 'block';
            return;
        }
        if (promptInput.value === "") {
            console.log("promptInput.value = " + promptInput.value)
            alert("Please enter a prompt before generating.");
            return;
        }
        for (let i = 0; i < nsfwWords.length; i++) {
            if (promptInput.value.toLowerCase().includes(nsfwWords[i])) {
                alert("We detected an NSFW word or an illegal token (e.g. '(' or '--'). Please enter a valid prompt.");
                {#const a = document.createElement('a');#}
                {#a.href = "/logout"#}
                {#document.body.appendChild(a);#}
                {#a.click();#}
                return;
            }
        }
        {#if (userScore > 3000) {#}
        {#    splashScreen.style.display = 'block';#}
        {#    document.getElementById("user-limit").style.display = 'block';#}
        {#    return;#}
        {# }#}

        hasGenerated = true;

        if (cachedImages.length > 0 && promptInput.value === formerPromptInput) {
            let clickedImage = document.querySelector('.clicked');

            // Replace the images that was not clicked with a cached image
            for (let i = 0; i < numImagesForDisplay; i++) {
                if (imageGrid.children[i].children[0] !== clickedImage) {
                    imageGrid.replaceChild(cachedImages.pop(), imageGrid.children[i]);
                }
            }
            prepareProgressBarTextForRanking();
        } else {
            while (cachedImages.length > 0) {
                cachedImages.pop();
            }
            const hostname = window.location.hostname;
            const port = window.location.port;
            let prefix = "wss"
            if (hostname === "127.0.0.1") {
                prefix = "ws"
            }
            const websocketAddr = prefix + "://" + hostname + ":" + port + "/ws";
            let ws = new WebSocket(websocketAddr);
            ws.onmessage = function (event) {
                const data = JSON.parse(event.data);
                const status = data.status;
                updateProgressBar(data);
                if (status === 'finished' && data.images) {
                    updateImages(data);
                    prepareProgressBarTextForRanking();
                    progressBar.style.width = "0";
                } else if (status === 'error') {
                    displayErrorMessage();
                } else if (status === 'failed') {
                    displayFailedMessage();
                }
            };

            ws.onopen = function () {
                let msg = JSON.stringify({prompt: promptInput.value, user_id: userId});
                ws.send(msg);
            };
        }

    }

    submitButton.addEventListener('click', function () {
            generate();
        }
    );

    function submitOnEnter(event) {
        if (event.key === "Enter" && submitButton.style.display === 'none') {
            progressBarText.style.backgroundColor = "#ec6565";
            progressBarText.style.boxShadow = "0 0 10px gold";
            progressBarText.style.color = "black";
            progressBarText.style.borderRadius = "1vmin";
            setTimeout(function () {
                progressBarText.style.backgroundColor = "";
                progressBarText.style.boxShadow = "";
                progressBarText.style.color = "";
                progressBarText.style.borderRadius = "";
            }, 1000);
        } else if (event.key === "Enter" && promptInput.value !== '') {
            event.preventDefault();
            submitButton.click();
        }
    }

    autoMode.addEventListener('change', (event) => {
        if (event.currentTarget.checked && submitButton.style.display !== 'none' && promptInput.value !== '') {
            generate();
        }
    })

    document.addEventListener("keydown", function (event) {
        submitOnEnter(event);
    });

    downloadButton.addEventListener('click', function () {
        const clickedImage = document.querySelector('.clicked');
        const prompt = promptInput.value;
        const imageUrl = clickedImage.src;
        const imageId = clickedImage.imageId;
        const allImages = document.querySelectorAll('.image-grid img');
        const imageIds = [];

        for (let i = 0; i < allImages.length; i++) {
            imageIds.push(allImages[i].imageId);
        }

        fetch(imageUrl)
            .then(response => response.blob())
            .then(blob => {
                const file = new Blob([blob], {type: 'image/png'});
                const fileUrl = URL.createObjectURL(file);
                const a = document.createElement('a');
                a.download = promptInput.value.replace(/\s/g, '_') + '.png';
                a.href = fileUrl;
                document.body.appendChild(a);
                a.click();
                URL.revokeObjectURL(fileUrl);
            });

        fetch('/update_download_image/', {
            method: 'POST',
            body: JSON.stringify({image_uid: imageId, image_uids: imageIds, prompt: prompt}),
            headers: {
                'Content-Type': 'application/json'
            }
        }).then(response => {
            // API call success
            console.log('Successfully updated clicked image');
        }).catch(error => {
            // API call error
            console.error('Error updating clicked image:', error);
        });
    });

    twitterButton.addEventListener('click', function () {
        const clickedImage = document.querySelector('.clicked');
        const prompt = promptInput.value;
        const imageId = clickedImage.imageId;
        const imageData = clickedImage.imageData;

        fetch('/tweet/', {
            method: 'POST',
            body: JSON.stringify({image_uid: imageId, prompt: prompt, image_data: imageData, user_id: userId}),
            headers: {
                'Content-Type': 'application/json'
            }
        }).then(response => {
            // API call success
            response.json().then(data => {
                const tweetText = data.tweet_text;
                const a = document.createElement('a');
                a.href = "https://twitter.com/intent/tweet?url=" + tweetText;
                a.target = "_blank";
                document.body.appendChild(a);
                a.click();
                console.log('Successfully tweeted image');
            });
        }).catch(error => {
            // API call error
            console.error('Error updating clicked image:', error);
        });
    });


    function clearDemo() {
        const progressBarText = document.querySelector('.progress-bar-text');
        const title = document.getElementById('title');
        const imageContainerChildren = imageGrid.children;
        promptInput.value = "";
        progressBarText.innerHTML = "<p></p>"
        neitherButton.style.display = 'none';
        title.innerHTML = '<h1 id="title" style="font-size: large;text-align: left;margin: 0">Pick a Pic: an <a onclick="activateModelInfo()">open</a> dataset </h1>'
        submitButton.style.display = 'block';
        submitButton.style.marginRight = '2%';

        for (let i = 0; i < imageContainerChildren.length; i++) {
            const imageChildren = imageContainerChildren[i].children;
            for (let j = 0; j < imageChildren.length; j++) {
                const image = imageChildren[j];
                image.style.opacity = 0;
                image.classList.add('after_clicked');
                if (image.classList.contains('clicked')) {
                    image.classList.remove('clicked');
                }
            }
        }
    }


</script>
</body>
</html>